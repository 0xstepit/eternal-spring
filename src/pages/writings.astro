---
import "../styles/global.css";
import Base from "../layouts/Base.astro";
import PostCardOneline from "../components/PostCardOneline.astro";

import { sortByDate, groupByYear } from "../scripts/writings.ts";
import type { WritingEntry } from "../types.ts";

import { getCollection, render } from "astro:content";
const allPosts = await getCollection("writings", ({ data }) => {
  return data["to-publish"] === true;
});

const sortedPosts: WritingEntry[] = sortByDate({
  posts: allPosts,
});

const groupedPosts = groupByYear(sortedPosts);

const postsWithMetaData = await Promise.all(
  sortedPosts.map(async (entry) => {
    // Call render() for each entry to get the injected metadata
    const { remarkPluginFrontmatter } = await render(entry);

    // Return the original entry data AND the extracted metadata
    return {
      entry,
      minutesRead: remarkPluginFrontmatter.minutesRead,
    };
  }),
);

const pageTitle = "Blog";
---

<Base pageTitle={pageTitle} pageStyle="clean">
  <div class="writings-container">
    <h1>All writings</h1>

    <div class="decorator">
      <span>+</span>
      <span>+</span>
      <span>+</span>
    </div>

    <p>All the wriitings divided by year.</p>

    <ul class="post-cards">
      {
        Array.from(groupedPosts.entries()).map(([year, posts]) => (
          <div class="group-writings">
            <h2>{year}</h2>
            {posts.map((entry) => (
              <PostCardOneline
                url={`/writings/${entry.id}/`}
                title={entry.data.title}
                summary={entry.data.summary}
                date={entry.data.date}
                tags={entry.data.tags}
              />
            ))}
          </div>
        ))
      }
      <!-- { -->
      <!--   postsWithMetaData.map(({ entry, minutesRead }) => { -->
      <!--     return ( -->
      <!--       <PostCard -->
      <!--         url={`/writings/${entry.id}/`} -->
      <!--         title={entry.data.title} -->
      <!--         summary={entry.data.summary} -->
      <!--         date={entry.data.date} -->
      <!--         tags={entry.data.tags} -->
      <!--       /> -->
      <!--     ); -->
      <!--   }) -->
      <!-- } -->
    </ul>
  </div>
</Base>
